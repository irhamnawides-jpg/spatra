  <!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Lembar Jawab Modal</title>
</head>
<body>

<button onclick="bukaModal()">Kerjakan Soal</button>

<!-- MODAL -->
<div id="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5);">
  <div style="background:#fff; width:90%; max-width:500px; margin:10% auto; padding:15px;">

    <h3>Lembar Jawab</h3>

    <label>Record (Index V)</label><br>
    <input type="number" id="record"><br><br>

    <label>BAB</label><br>
    <select id="bab">
      <option value="1">BAB 1</option>
      <option value="2">BAB 2</option>
      <option value="3">BAB 3</option>
      <option value="4">BAB 4</option>
      <option value="5">BAB 5</option>
    </select><br><br>

    <label>Aktivitas</label><br>
    <select id="aktivitas">
      <option value="1">Aktivitas 1</option>
      <option value="2">Aktivitas 2</option>
      <option value="3">Aktivitas 3</option>
      <option value="4">Aktivitas 4</option>
      <option value="5">Aktivitas 5</option>
    </select><br><br>

    <label>Jawaban Siswa</label><br>
    <textarea id="jawaban" rows="5" cols="55"></textarea><br><br>

    

    <button onclick="proses()">PROSES</button>
    <button onclick="tutupModal()">TUTUP</button>

    <pre id="status" hidden></pre>

  </div>
</div>

<script>
/* ================= KONFIG ================= */

const SHEET_ID = "1lueDGzRkaXb4XV0wnWlARF3OmkGnhIrP1Eg6fnBghf0";
const GID = "0";

const GAS_URL =
"https://script.google.com/macros/s/AKfycbxgUwH2H4uoNONhHlyKnChDLt8FuJaZTWrbp-SeN7FufiJzgpQFKfn6XjLgTKe30q5wHQ/exec";

const KUNCI = ["tauhid", "iman", "ibadah", "akhlak", "sejarah"];

const kolomNilai = {1:"G",2:"H",3:"I",4:"J",5:"K"};
const kolomJawab = {1:"L",2:"M",3:"N",4:"O",5:"P"};
const kolomGAS   = {1:7,2:8,3:9,4:10,5:11};

let NILAI_SEBELUMNYA = "";
let JWB_SEBELUMNYA = "";

/* ================= MODAL ================= */

function bukaModal() {
  document.getElementById("modal").style.display = "block";
}

function tutupModal() {
  document.getElementById("modal").style.display = "none";
}

/* ================= PROSES UTAMA ================= */

function proses() {
  const record = Number(document.getElementById("record").value);
  const bab = Number(document.getElementById("bab").value);
  const aktivitas = Number(document.getElementById("aktivitas").value);
  const jawaban = document.getElementById("jawaban").value.toLowerCase();

  if (!record || !jawaban) {
    alert("Record dan jawaban wajib diisi");
    return;
  }

  /* === 1. AMBIL DATA LAMA DARI SHEET === */
  const query = `
    SELECT ${kolomNilai[bab]}, ${kolomJawab[bab]}
    WHERE V = ${record}
  `;

  const url =
    `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?` +
    `gid=${GID}&tq=${encodeURIComponent(query)}`;

  fetch(url)
    .then(r => r.text())
    .then(t => {
      const json = JSON.parse(t.substr(47).slice(0, -2));
      const row = json.table.rows[0];

      NILAI_SEBELUMNYA = row?.c[0]?.v || "0#0#0#0#0";
      JWB_SEBELUMNYA   = row?.c[1]?.v || "-#-#-#-#-";

      /* === 2. KOREKSI JAWABAN === */
      let nilai = 60;
      if (jawaban.includes(KUNCI[aktivitas - 1])) nilai = 100;
      else if (jawaban.length > 30) nilai = 80;

      /* === 3. UPDATE ARRAY === */
      let arrNilai = NILAI_SEBELUMNYA.split("#");
      let arrJawab = JWB_SEBELUMNYA.split("#");

      arrNilai[aktivitas - 1] = nilai;
      arrJawab[aktivitas - 1] = jawaban;

      const NILAI_SETELAH = arrNilai.join("#");
      const JWB_SETELAH = arrJawab.join("#");

      /* === 4. KIRIM KE GAS === */
      const kolomgas = kolomGAS[bab];
      const kolomgas2 = kolomgas + 5;

      const fd = new URLSearchParams();
      fd.append("baris", record);
      fd.append("kolom", kolomgas);
      fd.append("kolom2", kolomgas2);
      fd.append("data", NILAI_SETELAH);
      fd.append("data2", JWB_SETELAH);

      return fetch(GAS_URL, { method: "POST", body: fd })
        .then(r => r.text())
        .then(res => {
          document.getElementById("status").textContent =
            "Nilai Aktivitas : " + nilai + "\n" +
            "NILAI SETELAH : " + NILAI_SETELAH + "\n" +
            "JAWABAN SETELAH : " + JWB_SETELAH + "\n\nRESPON GAS:\n" + res;
        });
    })
    .catch(err => {
      document.getElementById("status").textContent = err;
    });
}
</script>

</body>
</html>

